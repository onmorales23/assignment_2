---
title: "Data Analysis 2"
output: pdf_document
author: Ziying Li, Matt Capaldi, Yujuan Gao, Olivia Morales
date: \today
---

```{r setup, echo=T, include=T, message=F, warning=F, error=F}

## libraries
libs <- c("tidyverse", "haven", "bibtex", "psych", "knitr", "pastecs", "kableExtra","survey", "cobalt", "randomForest", "ipred","rpart", "baguette", "parsnip", "SimDesign", "bartCause", "lme4", "grf", "GenericML")

sapply(libs, require, character.only = TRUE)

## directory path (assignment_2 as current working directory)

data_dir <- file.path(".", "data")

## loading data
load(file.path(data_dir, "chapter_10_data_cleaned_and_imputed.Rdata"))

## making factored treatment variable 
data <- data %>%
  mutate(treated = as.factor(treated))
    
```

# Defining/Estimating Propensity Score Model

```{r pre q PSM model, echo = T, include = T, message=F, warning = F, error = F}

covariateNames <- c(
    "X1RTHETK1", 
    "X1MTHETK1",
    "X1TCHAPP", 
    "X1TCHCON",
    "X1TCHPER", 
    "X1TCHEXT",
    "X1TCHINT",
    "X1ATTNFS",
    "X1INBCNT",
    "X12MOMAR",
    "X1NUMSIB", 
    "P1OLDMOM",
    "P1CHLDBK",
    "P2DISTHM",
    "P1NUMPLA",
    "T2PARIN",
    "X12PAR1ED_I",
    "X12PAR2ED_I",
    "X2INCCAT_I",
    "X1PAR1EMP",
    "S2LUNCH",
    "X2KRCETH",
    "S2NGHBOR",
    "S2OUTSID",
    "S2USDABR",
    "S2PUBSOC",
    "X1LOCALE",
    "prop.missing",
    "S1_ID",
    "W1_2P0PSU")

covariateNames2 <- c(
    "X1RTHETK1", 
    "X1MTHETK1",
    "X1TCHAPP", 
    "X1TCHCON",
    "X1TCHPER", 
    "X1TCHEXT",
    "X1TCHINT",
    "X1ATTNFS",
    "X1INBCNT",
    "X12MOMAR",
    "X1NUMSIB", 
    "P1OLDMOM",
    "P1CHLDBK",
    "P2DISTHM",
    "P1NUMPLA",
    "T2PARIN",
    "X12PAR1ED_I",
    "X12PAR2ED_I",
    "X2INCCAT_I",
    "X1PAR1EMP",
    "S2LUNCH",
    "X2KRCETH",
    "S2NGHBOR",
    "S2OUTSID",
    "S2USDABR",
    "S2PUBSOC",
    "X1LOCALE")
    
#obtain the propensity score formula   
psFormula <- paste(covariateNames, collapse="+")
psFormula <- formula(paste("treated~", psFormula, sep=""))
print(psFormula)   

ps_model = glm(psFormula, data = data, family = binomial)

data$ps <- fitted(ps_model)

n <- 999
ps_matrix <- as.data.frame(data$ps)
ps_matrix <- cbind(ps_matrix, rep(ps_matrix[1], n))
ps_matrix <- as.matrix(ps_matrix)

```

# Estimating CATEs Using Machine Learning Methods
## BART
```{r q_1,BART, echo = T, include = T, message= F, warning = F, error = F}

# estimating conditional average treatment effects (CATEs) using BART

bart = bartc(response = T2TTABS, 
            treatment = treated, 
            ndpost = 1000,
            confounders = as.matrix(covariateNames2), 
            method.rsp = "p.weight", 
            method.trt = ps_matrix, 
            data = data, 
            estimand = "ate")


```

## GenericML 
```{r q_1 genML, echo = T, include = T, message = F, warning = F, error = F}
##' @Matt

learners <- c("random_forest", "lasso")

matrix_covs <- as.matrix(data %>% select(covariateNames) %>%
                           mutate(across(.fns = as.numeric))) 

X1 <- setup_X1(funs_Z = c("B", "S"))
               #fixed_effects = vil_pair)

vcov <- setup_vcov(estimator = "vcovHC")
                   #arguments = list(cluster = demi_paire))

library(parsnip)
ps_nnet <- mlp(mode = "classification",
               engine = "nnet",
hidden_units = 20) %>%
  fit(psFormula,
      data = data)
data$ps_nnet <- predict(ps_nnet,
                      new_data = data,
                      type = "prob")[,2]
data$ps_nnet <- data$ps_nnet$.pred_1 ## remove the $column.name

genML <- GenericML(
  Z = matrix_covs, #covariates
  D = as.numeric(as.character(data$treated)), #treatment
  Y = as.numeric(data$T2TTABS), #outcome
  learners_GenericML = learners,  # learners specified above
  learner_propensity_score = as.numeric(data$ps_nnet), #as.numeric(data$ps)  #ps
  num_splits = 10,                        # number splits of the data
  quantile_cutoffs = c(0.2, 0.4, 0.6, 0.8), # grouping for CATEs
  significance_level = 0.05,                # significance level
  X1_BLP = X1, X1_GATES = X1,               # regression setup
  vcov_BLP = vcov, vcov_GATES = vcov,       # covariance setup
  parallel = F, #num_cores = 6L, # parallelization
  seed = 20220621)                         # RNG seed

get_best(genML)
## random_forest is best, becomes the default for all future GenML functions

get_BLP(genML)
## Î²2 is significant indicating treatment heterogeneity

a <- get_GATES(genML) %>%
  plot()


# Plot parental education
b <- get_CLAN(genML,
         variable = "X12PAR1ED_I") %>%
  plot() +
  labs(title = "Heterogeneity by First Parents Education",
       y = str_wrap("Average Value of Parental Education", 25))

# Plot family marriage status
c <- get_CLAN(genML,
         variable = "X12MOMAR") %>%
  plot() +
  labs(title = "Heterogeneity by Parental Marriage Status",
       y = str_wrap("Average Value of Parental Marriage Status", 25))


# Plot lunch variable
d <- get_CLAN(genML,
         variable = "S2LUNCH") %>%
  plot() +
  labs(title = "Heterogeneity by Free School Lunch",
       y = str_wrap("Average Value of Students Receiving Free Lunch", 25))

# Plot percent coming from neighborhood
e <- get_CLAN(genML,
         variable = "S2NGHBOR") %>%
  plot() +
  labs(title = "Heterogeneity by Percent of School coming from 
       Surrounding Neighborhood",
       y = str_wrap("Average Value of Percent Coming from Neighborhood", 25))


library(patchwork)
layout <- c("#AA#
            BBCC
            DDEE")
a + b + c + d + e +
  plot_layout(design = layout)

```


## causal forests
```{r q_1 CF, echo = T, include = T, message = F, warning = F, error = F}


```

# Figures for Three Separate Methods

```{r q_2, echo = T, include = T, message = F, warning = F, error = F}

# BART
ggplot(data, aes(x=logit_scores, color = selfEmploy)) + 
  geom_boxplot() + ggtitle("Logit Regression")

# GenericML
ggplot(data, aes(x=forest_scores, color = selfEmploy)) + 
  geom_boxplot() + ggtitle("Random Forest")

# Causal Forests
ggplot(data, aes(x=GBM_scores, color = selfEmploy)) + 
  geom_boxplot() + ggtitle("GBM")


```

# Determine Best Linear Projection of CATE/Variable Importance
```{r q_3, echo = T, include = T, message = F, warning = F, error = F}


```


# Two most important CATE predictors (For each method), plot CATE/predictor relationship
```{r q_4, echo = T, include = T, message = F, warning = F, error = F}


```

